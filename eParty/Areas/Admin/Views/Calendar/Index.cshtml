@{
    ViewBag.Title = "Calendar";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="app-container">

    <div class="calendar-main-column">
        <h1><i class="fas fa-calendar-alt"></i> Event Calendar App</h1>
        <div class="header-controls" style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
            <button id="today-btn" style="padding:5px 10px;">Today</button>

            <div class="view-options">
                <button class="view-option active" data-view="day">Day</button>
                <button class="view-option" data-view="week">Week</button>
                <button class="view-option" data-view="month">Month</button>
            </div>

            <div class="date-navigation" style="display:flex;align-items:center;gap:10px;">
                <button id="prev-btn"><i class="fas fa-chevron-left"></i></button>
                <h2 id="current-date" style="margin:0;">Loading...</h2>
                <button id="next-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="calendar-view"
             id="calendar-view"
             data-create-url="@Url.Action("CreateEvent", "Calendar")"
             data-update-url="@Url.Action("UpdateEvent", "Calendar")"
             data-delete-url="@Url.Action("DeleteEvent", "Calendar")"
             data-approve-url="@Url.Action("ApproveEvent", "Calendar")">

            @* Loading Spinner *@
            <div id="calendar-loader">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Đang tải lịch...</p>
            </div>
        </div>
    </div>

    <div class="sidebar-column">
        <button id="toggle-sidebar" class="btn btn-sm btn-secondary mb-2">Toggle Events</button>
        <div id="event-sidebar">

            @* Các nút lọc (Tab) *@
            <ul class="nav nav-pills nav-fill mb-2" id="sidebar-filter">
                <li class="nav-item">
                    <a class="nav-link active" href="#" id="filter-upcoming">Upcoming</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="filter-pending">Pending</a>
                </li>
            </ul>

            <h3 id="sidebar-title">Upcoming Events</h3>
            <div id="events-list" style="min-height:200px;">
                <p>Loading events...</p>
            </div>
        </div>
    </div>
</div>

<button id="add-event-btn"
        style="position:fixed; bottom:30px; right:30px; background:#4e73df; color:#fff; border:none; padding:15px 25px; border-radius:50px; font-size:16px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
    Add Event
</button>

@* ========================== MODAL THÊM/SỬA SỰ KIỆN ========================== *@
<div id="event-modal" class="modal" style="display:none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center;">
    <div class="modal-content" style="background:#fff; padding:30px; border-radius:8px; width:90%; max-width: 500px; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,.5);">
        <span class="close-btn" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size: 24px; font-weight: bold;">&times;</span>
        <h4 id="modal-title">Add New Event</h4>
        <hr />
        <form id="event-form">
            <input type="hidden" id="event-id" />
            <input type="hidden" id="event-image-base64" />

            <div class="mb-3">
                <label for="event-title" class="form-label">Title</label>
                <input type="text" id="event-title" required class="form-control">
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="event-date" class="form-label">Date</label>
                    <input type="date" id="event-date" required class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="event-start-time" class="form-label">Start Time</label>
                    <input type="time" id="event-start-time" required class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="event-end-time" class="form-label">End Time</label>
                    <input type="time" id="event-end-time" required class="form-control">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="event-user" class="form-label">Người đặt (User)</label>
                    @Html.DropDownList("User", (SelectList)ViewBag.UsersList, "--- (Không chọn) ---", new { @class = "form-select", id = "event-user" })
                </div>
                <div class="col-md-6">
                    <label for="event-menu" class="form-label">Thực đơn (Menu)</label>
                    @Html.DropDownList("Menu", (SelectList)ViewBag.MenusList, "--- (Không chọn) ---", new { @class = "form-select", id = "event-menu" })
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="event-type" class="form-label">Loại (Type)</label>
                    <select id="event-type" class="form-select">
                        <option value="">--- (Không chọn) ---</option>
                        <option value="Vegetarian">Vegetarian (Ăn chay)</option>
                        <option value="NonVegetarian">Non-Vegetarian (Không chay)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="event-image-file" class="form-label">Ảnh (Image)</label>
                    <input type="file" id="event-image-file" class="form-control" accept="image/*" />
                </div>
            </div>

            <div class="mb-3" id="image-preview-container" style="display:none;">
                <label class="form-label">Xem trước ảnh:</label>
                <div>
                    <img id="event-image-preview" src="" style="max-width: 150px; height: auto; border-radius: 4px; border: 1px solid #ddd;" />
                    <button type="button" id="remove-image-btn" class="btn btn-danger btn-sm" style="vertical-align: top; margin-left: 10px;">Xóa ảnh</button>
                </div>
            </div>

            <div class="mb-3">
                <label for="event-address" class="form-label">Địa chỉ (Address)</label>
                <input type="text" id="event-address" class="form-control" />
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="event-latitude" class="form-label">Latitude</label>
                    <input type="number" step="any" id="event-latitude" class="form-control" placeholder="10.7769" />
                </div>
                <div class="col-md-6">
                    <label for="event-longitude" class="form-label">Longitude</label>
                    <input type="number" step="any" id="event-longitude" class="form-control" placeholder="106.7009" />
                </div>
            </div>


            <div class="mb-3">
                <label for="event-description" class="form-label">Description</label>
                <textarea id="event-description" class="form-control" rows="3"></textarea>
            </div>
            <div class="row mb-3 align-items-center">
                <div class="col-auto">
                    <label for="event-color" class="form-label">Color</label>
                    <input type="color" id="event-color" value="#4e73df" class="form-control form-control-color">
                </div>
                <div class="col form-check form-switch pt-4 ps-5">
                    <input class="form-check-input" type="checkbox" id="event-reminder">
                    <label class="form-check-label" for="event-reminder">Set Reminder (15 min)</label>
                </div>
            </div>

            <button type="button" id="save-event-btn" class="btn btn-primary">Save Event</button>
            <button type="button" class="btn btn-secondary close-btn">Cancel</button>
        </form>
    </div>
</div>

@* ========================== MODAL CHI TIẾT SỰ KIỆN ========================== *@
<div id="event-details-modal" class="modal" style="display:none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center;">
    <div class="modal-content" style="background:#fff; padding:20px; border-radius:8px; width:90%; max-width: 450px; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,.5);">
        <span class="close-btn" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size: 24px; font-weight: bold;">&times;</span>
        <h3 id="details-title" class="mb-3">Event Title</h3>
        <hr />
        <p><i class="fas fa-calendar-alt me-2 text-primary"></i> <strong id="details-date">Date</strong></p>
        <p><i class="fas fa-clock me-2 text-primary"></i> <strong id="details-time">Time</strong></p>

        <p><i class="fas fa-user me-2 text-primary"></i> <strong>Người đặt:</strong> <span id="details-user">N/A</span></p>
        <p><i class="fas fa-book-open me-2 text-primary"></i> <strong>Thực đơn:</strong> <span id="details-menu">N/A</span></p>

        <p><i class="fas fa-utensils me-2 text-primary"></i> <strong>Loại:</strong> <span id="details-type">N/A</span></p>

        <p><i class="fas fa-map-marker-alt me-2 text-primary"></i> <strong>Địa chỉ:</strong> <span id="details-address">N/A</span></p>
        <p><i class="fas fa-globe-americas me-2 text-primary"></i> <strong>Vĩ độ (Lat):</strong> <span id="details-lat">N/A</span></p>
        <p><i class="fas fa-globe-americas me-2 text-primary"></i> <strong>Kinh độ (Lng):</strong> <span id="details-lng">N/A</span></p>

        <div class="mt-2">
            <strong class="d-block mb-1">Ảnh:</strong>
            <img id="details-image" src="" style="max-width: 100%; height: auto; border-radius: 4px; display: none;" />
            <span id="details-image-none" style="display: none; color: #888;">(Không có ảnh)</span>
        </div>

        @* SỬA ĐỔI: Thêm <div> cho bản đồ *@
        <div class="mt-2">
            <strong class="d-block mb-1">Vị trí:</strong>
            <div id="details-map" style="height: 200px; width: 100%; border-radius: 4px; display: none;"></div>
            <span id="details-map-none" style="display: none; color: #888;">(Không có thông tin tọa độ)</span>
        </div>


        <p class="mt-3"><strong class="d-block mb-1">Description:</strong> <span id="details-description">Description goes here...</span></p>
        <hr />
        <div class="d-flex justify-content-end gap-2 mt-3">
            <button id="approve-event-btn" class="btn btn-success" style="display:none;"><i class="fas fa-check me-1"></i> Duyệt</button>
            <button id="edit-event-btn" class="btn btn-warning"><i class="fas fa-edit me-1"></i> Edit</button>
            <button id="delete-event-btn" class="btn btn-danger"><i class="fas fa-trash me-1"></i> Delete</button>
            <button id="close-details-btn" class="btn btn-secondary close-btn">Close</button>
        </div>
    </div>
</div>

@section Styles {
    @* SỬA ĐỔI: Thêm Leaflet CSS *@
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/Scripts/admin/calendar/style.css" />

    <style>
        .main-panel .container {
            max-width: 100% !important;
            padding: 0 !important;
        }

        .page-inner {
            padding: 0 !important;
        }

        .app-container {
            max-height: none !important;
            display: block !important;
            padding: 15px 0 0 0 !important;
            width: 100% !important;
            max-width: 1400px !important;
            margin: 0 auto !important;
        }

        .calendar-main-column,
        .sidebar-column {
            width: 100% !important;
            padding: 0 10px !important;
            border: none !important;
        }

        .sidebar-column {
            margin-top: 20px;
            padding-top: 20px !important;
            border-top: 1px solid #ddd !important;
        }

        #calendar-loader {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            color: #5a5c69;
        }

            #calendar-loader .spinner-border {
                width: 3rem;
                height: 3rem;
            }

            #calendar-loader p {
                margin-top: 15px;
                font-size: 1.1em;
                font-weight: 500;
            }

        /* --- Các style cũ vẫn giữ nguyên --- */
        :root {
            --hour-h: 50px;
        }

        .modal {
            z-index: 1055;
        }

        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-control-color {
            width: 50px;
            height: 38px;
            padding: .1rem .3rem;
        }

        #event-sidebar.open {
            display: block;
        }

        .day-grid {
            position: relative;
            display: grid;
            grid-template-columns: 60px 1fr;
            grid-template-rows: repeat(24, var(--hour-h));
            border-top: 1px solid #eee;
        }

        .events-overlay {
            position: absolute;
            top: 0;
            left: 60px;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }


        .day-event-abs {
            position: absolute;
            box-shadow: 0 1px 3px rgba(0,0,0,.15);
            color: #fff;
            font-size: 12px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            z-index: 1;
            left: 5px;
            right: 5px;
            border-radius: 4px;
            padding: 2px 5px;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0.9;
            border: 1px solid rgba(0,0,0,0.1);
        }

            .day-event-abs:hover {
                opacity: 1;
            }

        .hour-label {
            height: var(--hour-h);
            text-align: right;
            padding-right: 10px;
            font-size: 0.8em;
            color: #666;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            box-sizing: border-box;
            position: relative;
            line-height: var(--hour-h);
            padding-top: 0;
        }

        .day-time-block {
            height: var(--hour-h);
            border-bottom: 1px solid #eee;
            box-sizing: border-box;
        }


        .week-view {
            width: 100%;
            overflow-x: auto;
        }

        .week-header {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            border-bottom: 1px solid #ddd;
            min-width: 800px;
        }

        .hour-label-corner {
            height: auto;
            padding-bottom: 5px;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            min-width: 60px;
            box-sizing: border-box;
        }

        .week-day-header {
            text-align: center;
            padding: 5px 0;
            font-weight: 600;
            font-size: 0.9em;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            min-width: 100px;
            box-sizing: border-box;
        }

            .week-day-header:last-child {
                border-right: none;
            }

        .week-day-number {
            font-size: 1.1em;
            margin-top: 2px;
        }

        .week-day-header.current-day .week-day-number {
            background-color: #4e73df;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            display: inline-block;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            grid-template-rows: repeat(24, var(--hour-h));
            min-width: 800px;
        }

            .week-grid > .hour-label {
                grid-column: 1 / 2;
                height: var(--hour-h);
                text-align: right;
                padding-right: 10px;
                font-size: 0.8em;
                color: #666;
                border-right: 1px solid #eee;
                border-bottom: 1px solid #eee;
                box-sizing: border-box;
                position: relative;
                line-height: var(--hour-h);
                min-width: 60px;
            }

        .week-time-block {
            position: relative;
            height: var(--hour-h);
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
            box-sizing: border-box;
            min-width: 100px;
        }

            .week-time-block:nth-child(8n) {
                border-right: none;
            }

        .week-event {
            position: absolute;
            color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,.15);
            cursor: pointer;
            z-index: 1;
            left: 2px;
            right: 2px;
            background-color: #4e73df;
            opacity: .9;
            border-radius: 4px;
            font-size: 11px;
            padding: 1px 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            pointer-events: auto;
            border: 1px solid rgba(0,0,0,0.1);
        }

            .week-event:hover {
                opacity: 1;
            }


        .month-view {
            width: 100%;
            box-sizing: border-box;
        }

        .month-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .month-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .day-header {
            padding: 0.5rem 0.25rem;
            text-align: center;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .day-cell {
            aspect-ratio: 1/1;
            min-height: 100px;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

            .day-cell:hover {
                background-color: var(--secondary-color);
            }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.85em;
        }

        .day-events {
            overflow-y: auto;
            max-height: calc(100% - 1.5rem);
        }

        .day-event {
            font-size: 0.75rem;
            padding: 0.15rem 0.25rem;
            border-radius: 0.15rem;
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }

        .more-events {
            font-size: 0.7em;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }

        .other-month .day-number, .other-month .day-events {
            opacity: 0.5;
        }

        .current-day .day-number {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            margin: 0 auto 0.25rem;
        }
    </style>
}



@section Scripts {
    @* SỬA ĐỔI: Thêm Leaflet JS *@
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        var serverEvents = @ViewBag.ServerEventsJson;
console.log("Events embedded directly (serverEvents):", serverEvents);

        @if (ViewBag.CalendarError != null)
        {
            <text>
            document.addEventListener('DOMContentLoaded', function() {
                console.error("@ViewBag.CalendarError");
                var eventListEl = document.getElementById('events-list');
                if(eventListEl) {

              eventListEl.innerHTML = '<p style="color: red;">@ViewBag.CalendarError</p>';
                }
            });
</text>
        }
    </script>

    <script src="~/Scripts/admin/calendar/script.js"></script>
}